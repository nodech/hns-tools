#!/usr/bin/env node

'use strict';

const {CLI, CLIError} = require('../lib/cli');
const {Cache} = require('../lib/cache');
const util = require('../lib/utils/util');
const ansi = require('../lib/utils/ansi');

const restoreCursor = () => {
  if (process.stdout.isTTY)
    process.stdout.write(ansi.cursor.show);

  if (process.stderr.isTTY)
    process.stderr.write(ansi.cursor.show);
};

process.on('SIGINT', () => {
  restoreCursor();
  process.exit(1);
});

process.on('unhandledRejection', (err) => {
  restoreCursor();
  console.error(err);
  process.exit(3);
});

process.on('uncaughtException', (err) => {
  console.error(err);
  restoreCursor();
  process.exit(3);
});

let cli, cache;

(async () => {
  const config = util.getConfigs({
    argv: true,
    env: true
  }, {
    alias: {
      'h': 'help',
      'f': 'force'
    }
  });

  const argv = config.argv;

  if (isHelp(config)) {
    console.error(help());
    process.exit(1);
  }

  const options = {
    cwd: process.cwd()
  };

  const command = argv.shift();
  cli = new CLI({
    ...options,
    force: config.bool('force', false),
    renderer: config.str('ui', null),
    stderr: process.stderr,
    stdout: process.stdout
  });

  cache = new Cache({
    ...options
  });

  cli.init();
  cache.init();

  await cache.ensure();
  await cli.ensure();
  await cache.open();
  await cli.start();

  switch (command) {
    case 'git': {
      const subcmd = argv.shift();

      switch (subcmd) {
        case 'prlog': {
          break;
        }
        default: {
          throw new Error(
            `Subcommand "${subcmd}" of git not found. Check "help"`);
        }
      }
    }
    case 'example': {
      await cli.run('example');
      break;
    }
    default:
      throw new CLIError(`Command "${command}" not found. Check "help".`);
  }

  await cli.stop();
  await cache.close();
})().catch(async (e) => {
  restoreCursor();

  if (e instanceof CLIError) {
    console.error(e.message);
    process.exit(1);
  }

  throw e;
}).catch((e) => {
  console.error(e);
  process.exit(2);
});

function help() {
  return `hs-tools [tool options] command [command options]
Commands:
  help                   - Show this help.
  git                    - Git related subcommands

Git subcommands:
  prlog                  - Log formatted by PRs

Options:
  -h, --help             - show help
  -f, --force            - Ignore lock
  --ui=<type>            - text or loader

Examples:

`;
}

function isHelp(config) {
  if (config.bool('help'))
    return true;

  if (config.argv.length === 0)
    return true;

  if (config.argv[0] === 'help')
    return true;

  return false;
}
